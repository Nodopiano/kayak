version: '3'
services:
  kwp:
    build:
      context: ./docker
      dockerfile: Dockerfile
      args:
        HOST_GUID: ${USER_UID}
    ports:
    - 80:80
    volumes:
    - ./wp_html:/var/www/html
    - './docker/tools:/tools'
    env_file: ./.env
    networks:
      - wordpress
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 1m30s
      timeout: 10s
      retries: 3
  kdb:
    image: mariadb
    env_file: ./.env
    ports:
    - 3306:3306
    volumes:
    - wordpressmysql:/var/lib/mysql
    networks:
      - wordpress
  kmy:
    image: phpmyadmin/phpmyadmin
    ports:
      - 8181:80
    networks:
      - wordpress
    env_file: ./.env
  kwm:
    build:
      context: ./docker
      dockerfile: Dockerfile.wordmove
    volumes:
    - ./wp_html:/var/www/html
    - ./$MOVEFILE_PATH:/var/www/movefile.yml
    - $SSH_AUTH_SOCK:/ssh-agent # Forward local machine SSH key to docker
    environment:
      SSH_AUTH_SOCK: /ssh-agent
    env_file: ./.env
    networks:
      - wordpress
networks:
  wordpress:
    driver: "bridge"
volumes:
  wordpressmysql:
    driver: "local"
